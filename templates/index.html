<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Traffic Sign Detection</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        background-color: #121212;
        color: #fff;
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
      h1 {
        margin-top: 1rem;
      }
      .btn-group {
        margin: 1rem;
      }
      button {
        padding: 0.75rem 1.5rem;
        margin: 0.5rem;
        font-size: 1rem;
        background-color: #222;
        color: white;
        border: 1px solid #444;
        border-radius: 5px;
        cursor: pointer;
      }
      #videoElement {
        width: 90%;
        max-width: 480px;
        border: 1px solid #333;
        border-radius: 10px;
        margin: 1rem 0;
      }
      #resultImage {
        width: 90%;
        max-width: 480px;
        margin-top: 1rem;
        border-radius: 10px;
      }
    </style>
  </head>
  <body>
    <h1>Traffic Sign Detection</h1>
    <div style="margin-top: 1rem">
      <label for="modelSelect">Pilih Model:</label>
      <select id="modelSelect">
        <option value="yolo">YOLO</option>
        <option value="fast_rcnn">Faster R-CNN</option>
      </select>
    </div>
    <div class="btn-group">
      <button id="btnCamera">Live Detection</button>
      <button id="btnUpload">Upload Detection</button>
    </div>

    <div id="uploadContainer" style="display: none">
      <input type="file" id="fileInput" accept="image/*,video/*" />
    </div>

    <div id="cameraContainer" style="display: none">
      <video id="videoElement" autoplay playsinline></video>
    </div>

    <canvas id="canvas" style="display: none"></canvas>
    <img id="resultImage" src="" alt="Detection result" />
    <!-- <div
      id="descriptionBox"
      style="
        margin-top: 1rem;
        max-width: 480px;
        text-align: left;
        font-size: 0.9rem;
        color: #ccc;
      "
    ></div> -->
    <div
      id="descriptionBox"
      style="max-width: 480px; text-align: left; margin-top: 1rem"
    ></div>

    <script>
      const btnCamera = document.getElementById("btnCamera");
      const btnUpload = document.getElementById("btnUpload");
      const video = document.getElementById("videoElement");
      const canvas = document.getElementById("canvas");
      const fileInput = document.getElementById("fileInput");
      const resultImage = document.getElementById("resultImage");
      const cameraContainer = document.getElementById("cameraContainer");
      const uploadContainer = document.getElementById("uploadContainer");
      const modelSelect = document.getElementById("modelSelect"); // dropdown model
      let stream;
      let detecting = false;

      // Tombol Upload
      btnUpload.addEventListener("click", () => {
        cameraContainer.style.display = "none";
        uploadContainer.style.display = "block";
        stopStream();
      });

      // Tombol Kamera
      btnCamera.addEventListener("click", async () => {
        uploadContainer.style.display = "none";
        cameraContainer.style.display = "block";
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" },
          });
          video.srcObject = stream;
          startRealtimeDetection();
        } catch (err) {
          alert("Kamera gagal diakses: " + err.message);
        }
      });

      // Hentikan kamera
      function stopStream() {
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
          stream = null;
          detecting = false;
        }
      }

      // Live Detection dari kamera
      function startRealtimeDetection() {
        detecting = true;
        const interval = setInterval(async () => {
          if (!detecting) {
            clearInterval(interval);
            return;
          }

          if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas
              .getContext("2d")
              .drawImage(video, 0, 0, canvas.width, canvas.height);
            const image_data = canvas.toDataURL("image/jpeg");

            try {
              const selectedModel = modelSelect.value;
              const res = await fetch(`/detect-frame?model=${selectedModel}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ image: image_data }),
              });

              const data = await res.json();
              resultImage.src = data.image_url + "?t=" + new Date().getTime();
              document.getElementById("descriptionBox").innerText =
                data.description || "Tidak ada deskripsi.";
            } catch (err) {
              console.error("Gagal mengirim frame:", err);
            }
          }
        }, 1000);
      }

      fileInput.addEventListener("change", async () => {
        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append("file", file);

        const selectedModel = modelSelect.value;
        const res = await fetch(`/upload?model=${selectedModel}`, {
          method: "POST",
          body: formData,
        });

        const data = await res.json();
        resultImage.src = data.image_url + "?t=" + new Date().getTime();

        // Tampilkan deskripsi
        const descriptionBox = document.getElementById("descriptionBox");
        descriptionBox.innerText = data.description || "Tidak ada deskripsi.";
      });
    </script>
  </body>
</html>
